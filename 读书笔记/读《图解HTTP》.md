# 读《图解HTTP》

##### 了解Web及网络基础

###### HTTP的诞生

- 为知识共享而构建Web
  - HTML
  - HTTP
  - URI



##### 简单的HTTP协议

###### TCP/IP的分层管理

- 应用层
  - 决定了向用户提供应用服务时通信的活动
  - 例如，HTTP、FTP、DNS
- 传输层 
  - 提供处于网络连接中的两台计算机之间的数据传输
  - 例如，TCP、UDP
- 网络层 
  - 处理在网络上流动的数据包
  - IP
- 链路层 
  - 用来处理连接网络的硬件部分

###### URI和URL

- URI用字符串标识某一互联网资源
- URL表示资源的地点(互联网上所处的位置)
- URL是URI的子集

###### 持久连接节省通信量

- 持久连接的HTTP协议初始版本中，每进行一次HTTP通信就要断开一次TCP连接。例如，使用浏览器浏览一个包含多张图片的HTML页面时，在发送请求访问HTML页面资源的同时，也会请求该 HTML页面里包含的其它资源。因此，每次的请求都会造成无谓的TCP连接建立和断开，增加通信量的开销
- 持久连接的特点：只要任意一端没有明确提出断开连接，则保持TCP连接状态
- 持久连接的好处：减少了TCP连接的重复建立和断开所造成的额外开销，减轻了服务器端的负载。减少开销的那部分时间使HTTP请求和响应更早结束，Web页面显示速度也就相应提高了
- HTTP/1.1中所有的连接默认都是持久连接
- HTTP管线化能够做到同时并行发送多个请求，而不需要一个接一个地等待响应
  - [HTTP pipelining](https://en.wikipedia.org/wiki/HTTP_pipelining)

###### 使用Cookie的状态管理

- HTTP是无状态协议，它不对之前发生过的请求和响应的状态进行管理，即无法根据之前的状态进行本次的请求处理
- Cookie技术通过在请求和响应报文中写入Cookie信息来控制客户端的状态
  - 客户端第一次向服务器端发送请求时，服务器端生成SessionID，并将其添加到返回客户端的响应中
    - 在服务器端，Session可以存储在内存中，也可以持久化到文件、数据库、缓存（Memcache、Redis）中；服务器端Session只能在以下三种情况中被销毁：1.调用HttpSession.invalidate() 2.超时 3.服务器进程被停止
    - 在客户端，服务器端第一次返回的响应报文中会有一个Set-Cookie的首部字段信息，通知客户端保存Cookie。这个Cookie可以存储在内存中（进程中Cookie），也可以存储在本地硬盘中；大部分Session机制使用进程中Cookie来保存SessionID，关闭浏览器后这个进程消失，进程中的Cookie消失，那么SessionID也跟着消失了。如果想在下次打开浏览器时仍可以使用以前的Cookie，就需要将Cookie存储到硬盘中，直到失效为止
    - Session是解决HTTP协议无状态问题的服务器端解决方案，它能让客户端和服务器端一系列交互动作变成一个完整的事务，使网站变成一个真正意义上的软件 （https://blog.csdn.net/java_faep/article/details/78082802）
  - 当下次客服端再向服务器端发送请求时，客户端会自动在请求报文中加入Cookie值后发送出去；服务器端发现客户端发送过来的Cookie后会检查究竟是从哪个客户端发送过来的连接请求，然后对比服务器上的记录，最后得到之前的状态信息



##### HTTP报文内的HTTP信息

###### 请求报文及响应报文结构

> 占位放图

###### 报文主体和实体主体的差异

- 报文是HTTP通信中的基本单位，由8位组字节流组成，通过HTTP通信传输
- 实体作为请求或响应的有效载荷数据（补充项）被传输，其内容由实体首部和实体主体组成
- HTTP报文的主体用于传输 请求或响应 的实体主体
- 通常，报文主体等于实体主体。只有当传输中进行编码操作时，实体主体的内容发生变化，才导致实体主体和报文主体产生差异
  - 内容编码(Content-Encoding)
    - 把实体压缩变小后发送
  - 传输编码(Transfer-Encoding)
    - 在传输大容量数据时，通过把数据分割成多块，能够让浏览器逐步显示页面



##### 返回结果的HTTP状态码

状态码的职责是当客户端向服务器端发送请求时，描述返回的请求结果。

|      | 类别                             | 原因短语                   |
| ---- | -------------------------------- | -------------------------- |
| 1XX  | Informational（信息性状态码）    | 接收的请求正在处理         |
| 2XX  | Success（成功状态码）            | 请求正常处理完毕           |
| 3XX  | Redirection（重定向状态码）      | 需要进行附加操作以完成请求 |
| 4XX  | Client Error（客户端错误状态码） | 服务器无法处理请求         |
| 5XX  | Server Error（服务器错误状态码） | 服务器处理请求出错         |



##### 与HTTP协作的Web服务器

###### 通信数据转发

- 代理
  - “中间人”
- 网关
  - ？？
- 隧道
  - 在相隔甚远的客户端和服务器两者之间进行中转并保持双方通信连接的应用程序

###### 保存资源的缓存

- 缓存是指代理服务器或客户端本地磁盘内保存的资源副本。利用缓存可减少对源服务器的访问，因此也就节省了通信流量和通信时间。

  

##### HTTP首部

> 即用即查



##### 确保Web安全的HTTPS

###### HTTP的不足及解决

- 通信使用明文（未加密），内容可能会被窃听
  - ​	通信的加密 
    - 通过和SSL（Secure Socket Layer，安全套接层）、TLS（Transport Layer Security ，安全传输层协议）的组合使用，加密HTTP的通信内容
    - 用SSL建立安全通信线路之后，就可以在这条线路上进行HTTP通信。与SSL组合使用的HTTP被称为HTTPS
  - 内容的加密
    - 对HTTP报文进行加密处理后再发送请求
- 不验证通信方的身份，因此有可能遭遇伪装
  - 使用SSL证书避免以下问题
    - 伪装Web服务器
    - 伪装客户端
    - 访问权限未知
    - 请求的来源、去向未知
    - 无法阻止海量请求下的DoS攻击（Denial of Service，拒绝服务攻击）
- 无法证明报文的完整性，所以有可能已遭篡改
  - 中间人攻击

###### HTTPS

- HTTP+加密+认证+完整性保护=HTTPS
  - HTTPS并非是应用层的一种新协议，只是HTTP通信接口部分用TLS/SSL协议代替而已
- SSL采用公开密钥加密的加密方式
  - 加密方法
    - 对称加密（共享密钥加密）
      - 无法抵御中间人攻击
    - 非对称加密（公开密钥加密）
      - 发送方使用对方的公钥加密，接收方使用自身的私钥解密
      - 根据密文和公钥恢复原文会异常困难，本质上是对离散对数进行求值
- HTTPS采用混合加密机制
  - 公开密钥加密与共享密钥加密相比，其处理速度要慢
  - 在交换密钥环节使用公开密钥加密方式，之后的建立通信交换报文阶段则使用共享密钥加密方式
- 证明公开密钥正确性的证书
  1. 服务器将自己的公开密钥登录至数字证书认证机构
  2. 数字证书认证机构使用自己的私有密钥，向服务器的公开密钥署数字签名并颁发公钥证书
  3. 客户端拿到服务器的公钥证书后，使用数字证书认证机构的公开密钥，向数字证书认证机构验证公钥证书上的数字签名，以确认服务器的公开密钥的真实性
  4. 使用服务器的公开密钥对报文加密后发送
  5. 服务器用私有密钥对报文解密



##### 确认访问用户身份的认证

###### 何为认证

- 计算机本身无法判断坐在显示器前的使用者的身份
- 客户端自报家门，服务器核对“登录者本人才知道的信息”或“登录者本人才会有的信息”
  - 密码
  - 动态口令
  - 数字证书
  - 生物认证
  - IC卡
  - ...

###### HTTP使用的认证方式

- BASIC认证
  - Base64编码
  - 可明文解码
  - 一般浏览器无法实现认证注销
- DIGEST认证
- SSL客户端认证
- FormBase认证



##### 基于HTTP的功能追加协议

###### 基于HTTP的协议

- 建立HTTP标准规范用于传输HTML文档
- 随着时代发展，Web用途多样化，HTTP性能存在瓶颈
- 基于HTTP的Web浏览器的使用环境已遍布全球

###### 消除HTTP瓶颈的SPDY

- 海量用户的内容更新
- 使用HTTP协议探知服务器上是否有内容更新时，频繁从客户端到服务器端进行确认；若服务器端没有更新，就会产生无效通信
- 在现有Web实现所需功能时，一些HTTP标准会成为瓶颈
  - 一条连接上只可发送一条请求
  - 请求只能从客户端发起。客户端不可以接收除响应以外的指令
  - 请求/响应首部未经压缩就发送。首部信息越多延迟越大
  - 发送冗长的首部。每次互相发送相同的首部造成的浪费较大
  - 可任意选择数据压缩格式。非强制压缩发送
- Ajax的解决方法
  - 利用JavaScript和DOM的操作达到局部Web页面替换加载的异步通信手段
    - 响应中传输的数据量减少
  - Ajax实时从服务器获取内容，有可能会导致大量请求产生
- Comet的解决办法
  - 服务器端接收到请求后，Comet会先将请求挂起，当服务器端有内容更新时，再返回响应
  - 为了保留响应，一次连接的持续时间延长，为了维持连接会消耗更多的资源
- SPDY协议的目标是在协议级别消除HTTP所遭遇的瓶颈
  - 在TCP/IP的应用层与运输层之间新加会话层的形式运作
    - 多路复用流
    - 赋予请求优先级
    - 压缩HTTP首部
    - 推送功能
    - 服务器提供功能
  - Web浏览器及Web服务器需要为对应SPDY做一定改动
  - SPDY基本上只是将单个域名的通信多路复用，所以当一个Web网站使用多个域名下的资源时改善效果受到限制

###### 使用浏览器进行全双工通信的WebSocket

- WebSocket主要是为了解决 Ajax 和 Comet里 XMLHttpRequest 附带的缺陷所引起的问题 
  - 推送功能
  - 减少通信量

###### HTTP/2.0

- HTTP/2.0的目标是改善用户在使用Web时的速度体验

- 7项技术及讨论

  | 压缩                                                  | SPDY、 Friendly             |
  | ----------------------------------------------------- | --------------------------- |
  | 多路复用                                              | SPDY                        |
  | TLS 义务化                                            | Speed＋ Mobility            |
  | 协商                                                  | Speed＋ Mobility， Friendly |
  | 客户端拉曳（Client Pull） /服务器推送 （Server Push） | Speed＋ Mobility            |
  | 流量控制                                              | SPDY                        |
  | WebSocket                                             | Speed＋ Mobility            |

###### Web服务器管理文件的WebDAv

- WebDAV（Web-based Distributed Authoring and Versioning， 基于万维网的分布式创作和版本控制）是一个可对 Web 服务器上的内容直接进行文件复制、 编辑等操作的分布式文件系统 



##### 构建Web内容的技术

- HTML
  - CSS
  - DHTML
  - DOM
- Web应用
  - CGI
  - Servlet
- 数据发布格式及语言
  - XML
  - JSON



##### Web攻击技术

- 针对Web的攻击技术
  - HTTP协议本身不存在安全性问题，协议本身不会成为攻击目标。应用HTTP协议的服务器和客户端，以及运行在服务器上的Web应用等资源才是攻击目标。
  - 主动攻击
    - SQL注入攻击
    - OS命令注入攻击
  - 被动攻击
    - 跨站脚本攻击
    - 跨站点请求伪造
- 因输出值转义不完全引发的安全漏洞
  - SQL注入攻击
  - OS命令注入攻击
  - HTTP首部注入攻击
  - HTTP响应截断攻击
  - 邮件首部注入攻击
  - 远程文件包含漏洞
- 因设置或设计上的缺陷引发的安全漏洞
  - 强制浏览
  - 不正确的错误消息处理
  - 开放重定向
- 因会话管理疏忽引发的安全漏洞
  - 会话劫持
  - 会话固定攻击
  - 跨站点请求伪造
- 其他安全漏洞
  - 密码破解
  - 点击劫持（界面伪装）
  - DoS攻击
    - 集中利用访问请求造成资源过载，服务器资源用尽的同时，实际上服务也就处于停止状态
    - 通过攻击安全漏洞使服务停止
  - 后门程序
    - 开发阶段作为debug调用的后门程序
    - 开发者为了自身利益植入的后门程序
    - 攻击者通过某种方法设置的后门程序